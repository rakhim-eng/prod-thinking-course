# Инженерное мышление в продакшене

## Урок 3: Чеклист безопасного отката деплоя

Откат деплоя кажется простым делом. На практике восемьдесят процентов rollbackов создают новые проблемы. Потому что команда не подготовилась заранее. Деплой прошел гладко. А откат превращается в хаос. Всё из за отсутствия плана.

Первый шаг перед любым деплоем создать rollback план. Не держать его в голове. А записать на бумаге или в вики. С конкретными командами, проверками и точками контроля. Без этого откат превращается в импровизацию под давлением.

Возьми типичную ситуацию. Деплоишь новую версию сервиса. Через час начинаются таймауты. Хочешь откатить. Но команда не знает точную версию предыдущего образа. Конфигурация изменилась между деплоями. База данных уже содержит новые данные. Которые сломают старую версию.

Записанный план решает эти проблемы. В нём точный docker тег предыдущей версии. Ссылка на commit. Команды для отката каждого компонента. Проверки что откат прошёл успешно.

Мой случай. Деплоили миграцию схемы базы. Через сорок минут простоя команда нашла план отката. Там была команда для создания резервной копии схемы. Роллбэк миграции. Проверка что сервис читает данные правильно. Всё заняло двенадцать минут. Без плана ушли бы часа на два.

Второй важный момент точка разрыва. Решить заранее где останавливаешь откат. Если данные уже записались в новую схему откат может быть невозможен. Лучше остановиться и искать workaround.

Третий момент коммуникация. Откат это публичное событие. Объяви в канал заранее. Скажи что делаешь и почему. Дай статус каждые пять минут. Команда должна понимать происходящее.

Четвертый пункт после отката. Не просто радуйся что метрики нормализовались. Проверь что никаких скрытых последствий не осталось. Посмотри логи на предмет ошибок от частичного отката. Убедись что данные целы.

Пятый мониторинг после. Увеличивай внимание к метрикам на следующие сутки. Проблема может вернуться под другой нагрузкой. Или проявиться побочные эффекты.

Такой чеклист превращает откат из лотереи в контролируемый процесс. Команда перестаёт бояться деплоев. Знает что всегда есть выход.
